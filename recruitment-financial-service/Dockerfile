FROM gradle:8.5-jdk21 AS builder

ARG CODEARTIFACT_AUTH_TOKEN
ARG CODEARTIFACT_REPO_URL
ENV CODEARTIFACT_AUTH_TOKEN=${CODEARTIFACT_AUTH_TOKEN}
ENV CODEARTIFACT_REPO_URL=${CODEARTIFACT_REPO_URL}

WORKDIR /app

COPY . ./

RUN gradle build --no-daemon --refresh-dependencies -x test

FROM amazoncorretto:21-alpine

WORKDIR /app

COPY --from=builder /app/build/libs/*.jar ./app.jar

ARG JVM_OPTS="-Xms512m -Xmx6000m"
ARG GC_OPTS="-XX:+UseG1GC -XX:MaxGCPauseMillis=200"
ARG VERSION
ARG DD_GIT_REPOSITORY_URL
ARG DD_GIT_COMMIT_SHA

ENV JAVA_OPTS="${JVM_OPTS} ${GC_OPTS}"
ENV DD_VERSION=${VERSION}
ENV DD_GIT_REPOSITORY_URL=${DD_GIT_REPOSITORY_URL}
ENV DD_GIT_COMMIT_SHA=${DD_GIT_COMMIT_SHA}
ENV CURRENT_VERSION=$VERSION

EXPOSE 8080 9090

ENTRYPOINT ["java", "-jar", "/app/app.jar", "${JAVA_OPTS}"]
